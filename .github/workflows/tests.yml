name: Tests

on:
  pull_request:
    branches:
      - integration
  push:
    branches:
      - integration

jobs:
  tests:
    name: Run Tests
    runs-on: ubuntu-latest

    env:
      APP_ENV: test
      APP_DEBUG: 0
      DATABASE_URL: mysql://root:root@127.0.0.1:3306/docker_symfony_databaseMain

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: docker_symfony_databaseMain
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json
          coverage: none

      - name: Create .env file
        run: |
          cat > .env << 'EOF'
          APP_ENV=test
          APP_DEBUG=0
          DATABASE_URL=mysql://root:root@127.0.0.1:3306/docker_symfony_databaseMain
          DEFAULT_ROUTE_URI=http://localhost
          JWT_SECRET_KEY=%kernel.project_dir%/config/jwt/private.pem
          JWT_PUBLIC_KEY=%kernel.project_dir%/config/jwt/public.pem
          JWT_PASSPHRASE=test
          MESSENGER_TRANSPORT_DSN=doctrine://default
          CORS_ALLOW_ORIGIN=^https?://(localhost|127\.0\.0\.1)(:[0-9]+)?$
          EOF
          cp .env .env.test

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-progress --no-interaction --no-scripts

      - name: Create var directories
        run: |
          mkdir -p var/cache var/log
          chmod -R 777 var/

      - name: Wait for MySQL
        run: |
          for i in {1..30}; do
            if mysqladmin ping -h"127.0.0.1" -P3306 -uroot -proot --silent 2>/dev/null; then
              echo "✅ MySQL is ready"
              break
            fi
            echo "⏳ Waiting for MySQL... ($i/30)"
            sleep 2
          done

      - name: Create test databases
        run: |
          mysql -h127.0.0.1 -P3306 -uroot -proot -e "CREATE DATABASE IF NOT EXISTS docker_symfony_databaseMain;"
          mysql -h127.0.0.1 -P3306 -uroot -proot -e "CREATE DATABASE IF NOT EXISTS test_client_db;"
          echo "✅ Databases created"

      - name: Run Main DB migrations
        env:
          CI: true
          DB_USER: root
          DB_PASSWORD: root
        run: php migrations/main/migrate_main.php

      - name: Insert test client in main DB
        run: |
          mysql -h127.0.0.1 -P3306 -uroot -proot docker_symfony_databaseMain << 'EOF'
          INSERT INTO `client` (
            uuid_client,
            name,
            client_name,
            database_name,
            host,
            port_bbdd,
            database_user_name,
            database_password,
            active,
            business_type,
            fiscal_address,
            city,
            country,
            company_phone,
            is_verified,
            created_at
          ) VALUES (
            'test-client-uuid',
            'Test Client',
            'Test Client',
            'test_client_db',
            '127.0.0.1',
            3306,
            'root',
            'root',
            1,
            'HOSTELERIA',
            'Test Address 123',
            'Madrid',
            'España',
            '600000000',
            1,
            NOW()
          ) ON DUPLICATE KEY UPDATE database_name=VALUES(database_name);
          EOF
          echo "✅ Test client inserted"

      - name: Run Client DB migrations
        env:
          CI: true
        run: php migrations/client/migrate_client.php test-client-uuid

      - name: Run PHPUnit tests (Database only)
        env:
          CI: true
        run: vendor/bin/phpunit --testsuite="Database Tests" --testdox

      - name: Run Symfony Security Check
        run: composer audit
        continue-on-error: true